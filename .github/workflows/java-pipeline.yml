
name: "java_app_pipeline"

on:
  push:
   branches: [ main, develop, feature, hotfix, release ]

jobs:
  Codebuild:
    name: Codebuild
    uses: "./.github/workflows/templates/build.yml"
    with:
       runnerName: "ubuntu-latest"
       java-version: "11"
       distribution: "temurin"
       cache: "maven" 
    
  CodeScanning:
     name: SonarCloud Scan
     uses: "./.github/workflows/templates/code-quality.yml"
     needs: [ Codebuild ]
     secrets:
     
      GITTOKEN: "${{ secrets.GITTOKEN }}"
      SONAR_TOKEN: "${{ secrets.SONAR_TOKEN }}"
     
     with:
       java-version : "11.0.4"
       runnerName: "ubuntu-latest"
            
  buildImageandDeploy:
     name: Building docker image
     needs: [ Codebuild, CodeScanning]
     uses: "./.github/workflows/templates/deploy.yml"
     secrets:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
        DOCKER_REPO: ${{ secrets.DOCKER_REPO }}
        
     with:
       runnerName: "ubuntu-latest"
      
  TrivyScanner:
      name: Trivy Scan
      uses: "./.github/workflows/templates/trivyscan.yml"
      needs: [ Codebuild,CodeScanning, buildImageandDeploy ] 
      secrets:
        DOCKER_REPO: ${{ secrets.DOCKER_REPO }}
      with:
       runnerName: "ubuntu-latest"
       
  Terraform:
      name: Terraform setup
      uses: "./.github/workflows/templates/terraform.yml"
      needs: [ Codebuild,CodeScanning, buildImageandDeploy,TrivyScanner ] 
      secrets:
        TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
      with:
       runnerName: "ubuntu-latest"
      
      
